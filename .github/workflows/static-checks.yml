name: Static code checks
on: [push, pull_request]
jobs:
  phpunit:
    strategy:
      matrix:
        cfg:
          - { os: 'ubuntu-20.04', php: '7.4' }
          - { os: 'ubuntu-22.04', php: '8.1' }
    runs-on: ${{ matrix.cfg.os }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup PHP, composer
        uses: ./.github/actions/setup-php
        with:
          php-version: ${{ matrix.cfg.php }}
      - name: Setup MySQL, install schema
        uses: ./.github/actions/setup-mysql-db
      - name: Install aspell dependencies for WordCheck tests
        run: sudo apt --fix-broken install aspell aspell-en
      - name: Run phpunit tests
        run: cd SETUP/tests && ../../vendor/bin/phpunit
  jsunit:
    strategy:
      matrix:
        cfg:
          - { os: 'ubuntu-20.04', php: '7.4' }
          - { os: 'ubuntu-22.04', php: '8.1' }
    runs-on: ${{ matrix.cfg.os }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node, NPM
        uses: ./.github/actions/setup-node
      - name: Run js unit tests
        run: npm run test
  linting:
    strategy:
      matrix:
        cfg:
          - { os: 'ubuntu-20.04', php: '7.4' }
          - { os: 'ubuntu-22.04', php: '8.1' }
    runs-on: ${{ matrix.cfg.os }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup PHP, composer
        uses: ./.github/actions/setup-php
        with:
          php-version: ${{ matrix.cfg.php }}
      - name: Setup Node, NPM
        uses: ./.github/actions/setup-node
      - name: Lint PHP code
        run: make -C SETUP lint_code
      - name: Run JS lint
        run: npm run lint
      - name: Run PHP-CS-Fixer and confirm no changes
        run: ./vendor/bin/php-cs-fixer fix --show-progress=none --dry-run --diff
  misc_checks:
    strategy:
      matrix:
        cfg:
          - { os: 'ubuntu-20.04', php: '7.4' }
          - { os: 'ubuntu-22.04', php: '8.1' }
    runs-on: ${{ matrix.cfg.os }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup PHP, composer
        uses: ./.github/actions/setup-php
        with:
          php-version: ${{ matrix.cfg.php }}
      - name: Setup Node, NPM
        uses: ./.github/actions/setup-node
      - name: Run security checks
        run: make -C SETUP security_checks
      - name: Run charsuite checks
        run: make -C SETUP lint_charsuites
      - name: Run less/CSS checks
        run: make -C SETUP lint_css
      - name: Run best practice checks
        run: make -C SETUP best_practice_checks
